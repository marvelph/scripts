#!/usr/bin/env bash
# ssh-add-select - Select an IdentityFile from ~/.ssh/config and run ssh-add
#
# Usage:
#   ssh-add-select

set -euo pipefail

CONFIG_FILE="${HOME}/.ssh/config"

die() {
    echo "Error: $*" >&2
    exit 1
}

need_cmd() {
    command -v "$1" >/dev/null 2>&1 || die "'$1' command is required."
}

array_contains() {
    local needle="$1"
    shift
    local item
    for item in "$@"; do
        if [[ "$item" == "$needle" ]]; then
            return 0
        fi
    done
    return 1
}

choose_one() {
    local prompt="$1"
    shift
    local -a items=("$@")
    local choice rc=0

    if (( ${#items[@]} == 0 )); then
        return 1
    fi

    if command -v fzf >/dev/null 2>&1; then
        choice="$(printf '%s\n' "${items[@]}" | fzf --prompt="$prompt" --height=40% --reverse)" || rc=$?
        case "$rc" in
            0) ;;
            1|130) return 2 ;;
            *) die "failed to select an item with fzf." ;;
        esac
        [[ -n "$choice" ]] || return 2
        printf '%s\n' "$choice"
        return 0
    fi

    echo "Info: 'fzf' not found. Falling back to numbered selection." >&2
    select choice in "${items[@]}"; do
        [[ -n "${choice:-}" ]] || { echo "Invalid selection." >&2; continue; }
        printf '%s\n' "$choice"
        return 0
    done

    return 2
}

normalize_identity_path() {
    local identity="$1"

    if [[ "$identity" == \"*\" ]]; then
        identity="${identity#\"}"
        identity="${identity%\"}"
    elif [[ "$identity" == \'*\' ]]; then
        identity="${identity#\'}"
        identity="${identity%\'}"
    fi

    if [[ "$identity" == "~/"* ]]; then
        identity="${HOME}/${identity#\~/}"
    elif [[ "$identity" != /* ]]; then
        identity="${HOME}/${identity}"
    fi

    printf '%s\n' "$identity"
}

need_cmd ssh-add

if [[ ! -f "$CONFIG_FILE" ]]; then
    die "$CONFIG_FILE not found"
fi

KEYS=()
while IFS= read -r identity; do
    [[ -n "$identity" ]] || continue

    identity="$(normalize_identity_path "$identity")"

    if [[ "$identity" == *"%"* ]]; then
        continue
    fi

    if (( ${#KEYS[@]} == 0 )) || ! array_contains "$identity" "${KEYS[@]}"; then
        KEYS+=("$identity")
    fi
done < <(
    awk '
        {
            sub(/[[:space:]]+#.*/, "", $0)
        }
        /^[[:space:]]*[Ii][Dd][Ee][Nn][Tt][Ii][Tt][Yy][Ff][Ii][Ll][Ee][[:space:]]+/ {
            for (i = 2; i <= NF; i++) {
                print $i
            }
        }
    ' "$CONFIG_FILE"
)

if (( ${#KEYS[@]} == 0 )); then
    echo "No IdentityFile entries found in $CONFIG_FILE." >&2
    exit 0
fi

if selected="$(choose_one "Select SSH Key> " "${KEYS[@]}")"; then
    :
else
    rc=$?
    case "$rc" in
        2)
            echo "No key selected. ssh-add skipped." >&2
            exit 0
            ;;
        *)
            die "failed to choose key."
            ;;
    esac
fi

echo "Adding key: $selected"
ssh-add "$selected"
