#!/usr/bin/env zsh
# ssh-add-select - Select an IdentityFile from ~/.ssh/config and run ssh-add
#
# Usage:
#   ssh-add-select

emulate -L zsh
setopt ERR_EXIT NO_UNSET PIPE_FAIL

typeset -r CONFIG_FILE="${HOME}/.ssh/config"

_die() {
  print -u2 -- "Error: $*"
  exit 1
}

_need_cmd() {
  command -v -- "$1" >/dev/null 2>&1 || _die "'$1' command is required."
}

_choose_one() {
  emulate -L zsh
  setopt NO_UNSET PIPE_FAIL

  typeset prompt="$1"
  shift
  typeset -a items=("$@")
  typeset choice
  integer rc

  (( $#items > 0 )) || return 1

  if ! choice="$(printf '%s\n' "${items[@]}" | fzf --prompt="$prompt" --height=40% --reverse)"; then
    rc=$?
    case "$rc" in
      1|130) return 2 ;;
      *) _die "failed to select an item with fzf." ;;
    esac
  fi

  [[ -n "$choice" ]] || return 2
  print -r -- "$choice"
}

_normalize_identity_path() {
  emulate -L zsh
  setopt NO_UNSET

  typeset identity="$1"

  if [[ "$identity" == \"*\" ]]; then
    identity="${identity#\"}"
    identity="${identity%\"}"
  elif [[ "$identity" == \'*\' ]]; then
    identity="${identity#\'}"
    identity="${identity%\'}"
  fi

  if [[ "$identity" == "~/"* ]]; then
    identity="${HOME}/${identity#\~/}"
  elif [[ "$identity" != /* ]]; then
    identity="${HOME}/${identity}"
  fi

  print -r -- "$identity"
}

main() {
  emulate -L zsh
  setopt ERR_EXIT NO_UNSET PIPE_FAIL

  typeset identity selected
  integer rc
  typeset -A seen
  typeset -a keys

  _need_cmd ssh-add
  _need_cmd fzf

  [[ -f "$CONFIG_FILE" ]] || _die "$CONFIG_FILE not found"

  while IFS= read -r identity; do
    [[ -n "$identity" ]] || continue

    identity="$(_normalize_identity_path "$identity")"
    [[ "$identity" == *"%"* ]] && continue

    if (( ${+seen[$identity]} )); then
      continue
    fi

    seen[$identity]=1
    keys+=("$identity")
  done < <(
    awk '
      {
        sub(/[[:space:]]+#.*/, "", $0)
      }
      /^[[:space:]]*[Ii][Dd][Ee][Nn][Tt][Ii][Tt][Yy][Ff][Ii][Ll][Ee][[:space:]]+/ {
        for (i = 2; i <= NF; i++) {
          print $i
        }
      }
    ' "$CONFIG_FILE"
  )

  if (( $#keys == 0 )); then
    print -u2 -- "No IdentityFile entries found in $CONFIG_FILE."
    return 0
  fi

  if selected="$(_choose_one "Select SSH Key> " "${keys[@]}")"; then
    :
  else
    rc=$?
    case "$rc" in
      2)
        print -u2 -- "No key selected. ssh-add skipped."
        return 0
        ;;
      *)
        _die "failed to choose key."
        ;;
    esac
  fi

  print -- "Adding key: $selected"
  ssh-add "$selected"
}

main "$@"
