#!/usr/bin/env zsh
# ssh-select - Select an SSH host alias and run ssh/sftp
#
# Usage:
#   ssh-select [-m ssh|sftp]

setopt ERR_EXIT NO_UNSET PIPE_FAIL

CONFIG_FILE="${HOME}/.ssh/config"
MODE="ssh"

die() {
    echo "Error: $*" >&2
    exit 1
}

need_cmd() {
    command -v "$1" >/dev/null 2>&1 || die "'$1' command is required."
}

choose_one() {
    local prompt="$1"
    shift
    local -a items=("$@")
    local choice rc=0

    if (( ${#items[@]} == 0 )); then
        return 1
    fi

    if command -v fzf >/dev/null 2>&1; then
        choice="$(printf '%s\n' "${items[@]}" | fzf --prompt="$prompt" --height=40% --reverse)" || rc=$?
        case "$rc" in
            0) ;;
            1|130) return 2 ;;
            *) die "failed to select an item with fzf." ;;
        esac
        [[ -n "$choice" ]] || return 2
        printf '%s\n' "$choice"
        return 0
    fi

    return 1
}

usage() {
    cat <<'EOF'
Usage: ssh-select [-m ssh|sftp]
       ssh-select [--mode ssh|sftp]
EOF
}

while (($# > 0)); do
    case "$1" in
        -m|--mode)
            if (($# < 2)); then
                echo "Error: mode requires an argument (ssh or sftp)" >&2
                usage >&2
                exit 1
            fi
            MODE="$2"
            shift 2
            ;;
        -h|--help)
            usage
            exit 0
            ;;
        *)
            echo "Error: unknown argument: $1" >&2
            usage >&2
            exit 1
            ;;
    esac
done

if [[ "$MODE" != "ssh" && "$MODE" != "sftp" ]]; then
    die "invalid mode: $MODE (expected: ssh or sftp)"
fi

need_cmd fzf

if [[ ! -f "$CONFIG_FILE" ]]; then
    die "$CONFIG_FILE not found"
fi

HOSTS="$(
    awk '
        {
            sub(/[[:space:]]+#.*/, "", $0)
        }
        /^[[:space:]]*[Hh][Oo][Ss][Tt][[:space:]]+/ {
            for (i = 2; i <= NF; i++) {
                host = $i
                if (host ~ /^[*!]/) {
                    continue
                }
                if (host ~ /[*?]/) {
                    continue
                }
                if (!(host in seen)) {
                    seen[host] = 1
                    print host
                }
            }
        }
    ' "$CONFIG_FILE"
)"

if [[ -z "$HOSTS" ]]; then
    echo "No concrete host entries found in $CONFIG_FILE." >&2
    exit 0
fi

HOST_LIST=()
while IFS= read -r host; do
    [[ -n "$host" ]] && HOST_LIST+=("$host")
done < <(printf '%s\n' "$HOSTS")
if selected="$(choose_one "Select SSH Host> " "${HOST_LIST[@]}")"; then
    :
else
    rc=$?
    case "$rc" in
        2)
            echo "No host selected. Connection skipped." >&2
            exit 0
            ;;
        *)
            die "failed to choose host."
            ;;
    esac
fi

if [[ "$MODE" == "ssh" ]]; then
    exec ssh "$selected"
fi

exec sftp "$selected"
