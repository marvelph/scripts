#!/usr/bin/env zsh
# ssh-select - Select an SSH host alias and run ssh/sftp
#
# Usage:
#   ssh-select [-m ssh|sftp]

emulate -L zsh
setopt ERR_EXIT NO_UNSET PIPE_FAIL

typeset -r CONFIG_FILE="${HOME}/.ssh/config"

_die() {
  print -u2 -- "Error: $*"
  exit 1
}

_need_cmd() {
  command -v -- "$1" >/dev/null 2>&1 || _die "'$1' command is required."
}

_choose_one() {
  emulate -L zsh
  setopt NO_UNSET PIPE_FAIL

  typeset prompt="$1"
  shift
  typeset -a items=("$@")
  typeset choice
  integer rc

  (( $#items > 0 )) || return 1

  if ! choice="$(printf '%s\n' "${items[@]}" | fzf --prompt="$prompt" --height=40% --reverse)"; then
    rc=$?
    case "$rc" in
      1|130) return 2 ;;
      *) _die "failed to select an item with fzf." ;;
    esac
  fi

  [[ -n "$choice" ]] || return 2
  print -r -- "$choice"
}

_usage() {
  cat <<'USAGE'
Usage: ssh-select [-m ssh|sftp]
       ssh-select [--mode ssh|sftp]
USAGE
}

main() {
  emulate -L zsh
  setopt ERR_EXIT NO_UNSET PIPE_FAIL

  typeset mode="ssh"
  typeset host selected hosts_output
  integer rc
  typeset -a host_list
  typeset -a mode_opt help_opt

  zparseopts -D -E -K m:=mode_opt -mode:=mode_opt h=help_opt -help=help_opt || {
    _usage >&2
    return 1
  }

  if (( $#help_opt > 0 )); then
    _usage
    return 0
  fi

  if (( $#mode_opt > 0 )); then
    mode="${mode_opt[-1]}"
  fi

  if (( $# > 0 )); then
    print -u2 -- "Error: unknown argument: $1"
    _usage >&2
    return 1
  fi

  if [[ "$mode" != "ssh" && "$mode" != "sftp" ]]; then
    _die "invalid mode: $mode (expected: ssh or sftp)"
  fi

  _need_cmd fzf

  [[ -f "$CONFIG_FILE" ]] || _die "$CONFIG_FILE not found"

  hosts_output="$({
    awk '
      {
        sub(/[[:space:]]+#.*/, "", $0)
      }
      /^[[:space:]]*[Hh][Oo][Ss][Tt][[:space:]]+/ {
        for (i = 2; i <= NF; i++) {
          host = $i
          if (host ~ /^[*!]/) {
            continue
          }
          if (host ~ /[*?]/) {
            continue
          }
          if (!(host in seen)) {
            seen[host] = 1
            print host
          }
        }
      }
    ' "$CONFIG_FILE"
  })"

  host_list=("${(@f)hosts_output}")
  host_list=("${(@)host_list:#}")

  if (( $#host_list == 0 )); then
    print -u2 -- "No concrete host entries found in $CONFIG_FILE."
    return 0
  fi

  if selected="$(_choose_one "Select SSH Host> " "${host_list[@]}")"; then
    :
  else
    rc=$?
    case "$rc" in
      2)
        print -u2 -- "No host selected. Connection skipped."
        return 0
        ;;
      *)
        _die "failed to choose host."
        ;;
    esac
  fi

  if [[ "$mode" == "ssh" ]]; then
    exec ssh "$selected"
  fi

  exec sftp "$selected"
}

main "$@"
