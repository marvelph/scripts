#!/usr/bin/env bash
# aws-login - Select an AWS profile and run aws sso login
#
# Usage:
#   aws-login

set -euo pipefail

die() {
    echo "Error: $*" >&2
    exit 1
}

need_cmd() {
    command -v "$1" >/dev/null 2>&1 || die "'$1' command is required."
}

choose_one() {
    local prompt="$1"
    shift
    local -a items=("$@")
    local choice rc=0

    if (( ${#items[@]} == 0 )); then
        return 1
    fi

    if command -v fzf >/dev/null 2>&1; then
        choice="$(printf '%s\n' "${items[@]}" | fzf --prompt="$prompt" --height=40% --reverse)" || rc=$?
        case "$rc" in
            0) ;;
            1|130) return 2 ;;
            *) die "failed to select an item with fzf." ;;
        esac
        [[ -n "$choice" ]] || return 2
        printf '%s\n' "$choice"
        return 0
    fi

    echo "Info: 'fzf' not found. Falling back to numbered selection." >&2
    select choice in "${items[@]}"; do
        [[ -n "${choice:-}" ]] || { echo "Invalid selection." >&2; continue; }
        printf '%s\n' "$choice"
        return 0
    done

    return 2
}

need_cmd aws

profiles=()
while IFS= read -r p; do
    [[ -n "$p" ]] && profiles+=("$p")
done < <(aws configure list-profiles)
(( ${#profiles[@]} > 0 )) || die "No AWS profiles found."

config_file="${AWS_CONFIG_FILE:-$HOME/.aws/config}"

get_sso_profiles_from_config() {
    local file="$1"
    [[ -r "$file" ]] || return 0

    awk '
    function emit_section() {
        if (profile != "" && (has_sso_start_url || has_sso_session || (has_account && has_role))) {
            print profile
        }
    }
    function reset_flags() {
        has_sso_start_url = 0
        has_sso_session = 0
        has_account = 0
        has_role = 0
    }
    /^\[.*\]$/ {
        emit_section()
        profile = ""
        reset_flags()

        if ($0 ~ /^\[profile[[:space:]]+/) {
            profile = $0
            sub(/^\[profile[[:space:]]+/, "", profile)
            sub(/\]$/, "", profile)
        } else if ($0 ~ /^\[default\]$/) {
            profile = "default"
        }
        next
    }
    {
        if (profile == "") {
            next
        }
        if ($0 ~ /^[[:space:]]*sso_start_url[[:space:]]*=/) {
            has_sso_start_url = 1
        } else if ($0 ~ /^[[:space:]]*sso_session[[:space:]]*=/) {
            has_sso_session = 1
        } else if ($0 ~ /^[[:space:]]*sso_account_id[[:space:]]*=/) {
            has_account = 1
        } else if ($0 ~ /^[[:space:]]*sso_role_name[[:space:]]*=/) {
            has_role = 1
        }
    }
    END {
        emit_section()
    }
    ' "$file"
}

sso_profile_list="$(get_sso_profiles_from_config "$config_file")"
sso_profiles=()

for p in "${profiles[@]}"; do
    if [[ -n "$sso_profile_list" ]] && printf '%s\n' "$sso_profile_list" | grep -Fxq -- "$p"; then
        sso_profiles+=("$p")
    fi
done

if (( ${#sso_profiles[@]} == 0 )); then
    sso_profiles=("${profiles[@]}")
fi

if profile="$(choose_one "Select AWS Profile> " "${sso_profiles[@]}")"; then
    :
else
    rc=$?
    case "$rc" in
        2)
            echo "No profile selected. Login skipped." >&2
            exit 0
            ;;
        *)
            die "failed to choose profile."
            ;;
    esac
fi

echo "Logging in to SSO for profile: $profile"
AWS_PROFILE="$profile" aws sso login
