#!/usr/bin/env zsh
# aws-login - Select an AWS profile and run aws sso login
#
# Usage:
#   aws-login

setopt ERR_EXIT NO_UNSET PIPE_FAIL

die() {
    echo "Error: $*" >&2
    exit 1
}

need_cmd() {
    command -v "$1" >/dev/null 2>&1 || die "'$1' command is required."
}

choose_one() {
    local prompt="$1"
    shift
    local -a items=("$@")
    local choice rc=0

    if (( ${#items[@]} == 0 )); then
        return 1
    fi

    if command -v fzf >/dev/null 2>&1; then
        choice="$(printf '%s\n' "${items[@]}" | fzf --prompt="$prompt" --height=40% --reverse)" || rc=$?
        case "$rc" in
            0) ;;
            1|130) return 2 ;;
            *) die "failed to select an item with fzf." ;;
        esac
        [[ -n "$choice" ]] || return 2
        printf '%s\n' "$choice"
        return 0
    fi

    return 1
}

need_cmd aws
need_cmd fzf

profiles=()
while IFS= read -r p; do
    [[ -n "$p" ]] && profiles+=("$p")
done < <(aws configure list-profiles)
(( ${#profiles[@]} > 0 )) || die "No AWS profiles found."

if profile="$(choose_one "Select AWS Profile> " "${profiles[@]}")"; then
    :
else
    rc=$?
    case "$rc" in
        2)
            echo "No profile selected. Login skipped." >&2
            exit 0
            ;;
        *)
            die "failed to choose profile."
            ;;
    esac
fi

echo "Logging in to SSO for profile: $profile"
AWS_PROFILE="$profile" aws sso login
