#!/usr/bin/env zsh
# aws-login - Select an AWS profile and run aws sso login
#
# Usage:
#   aws-login

emulate -L zsh
setopt ERR_EXIT NO_UNSET PIPE_FAIL

_die() {
  print -u2 -- "Error: $*"
  exit 1
}

_need_cmd() {
  command -v -- "$1" >/dev/null 2>&1 || _die "'$1' command is required."
}

_choose_one() {
  emulate -L zsh
  setopt NO_UNSET PIPE_FAIL

  typeset prompt="$1"
  shift
  typeset -a items=("$@")
  typeset choice
  integer rc

  (( $#items > 0 )) || return 1

  if ! choice="$(printf '%s\n' "${items[@]}" | fzf --prompt="$prompt" --height=40% --reverse)"; then
    rc=$?
    case "$rc" in
      1|130) return 2 ;;
      *) _die "failed to select an item with fzf." ;;
    esac
  fi

  [[ -n "$choice" ]] || return 2
  print -r -- "$choice"
}

main() {
  emulate -L zsh
  setopt ERR_EXIT NO_UNSET PIPE_FAIL

  typeset profile
  integer rc
  typeset -a profiles

  _need_cmd aws
  _need_cmd fzf

  profiles=("${(@f)$(aws configure list-profiles)}")
  profiles=("${(@)profiles:#}")
  (( $#profiles > 0 )) || _die "No AWS profiles found."

  if profile="$(_choose_one "Select AWS Profile> " "${profiles[@]}")"; then
    :
  else
    rc=$?
    case "$rc" in
      2)
        print -u2 -- "No profile selected. Login skipped."
        return 0
        ;;
      *)
        _die "failed to choose profile."
        ;;
    esac
  fi

  print -- "Logging in to SSO for profile: $profile"
  AWS_PROFILE="$profile" aws sso login
}

main "$@"
